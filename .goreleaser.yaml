# yaml-language-server: $schema=https://goreleaser.com/static/schema.json
version: 2
project_name: DNS4ACME
# Binary builds:
builds:
  - id: "binary"
    main: ./cmd/dns4acme
    binary: dns4acme
    env:
      - CGO_ENABLED=0
    tags:
      - kubernetes
    goos:
      - linux
      - windows
    goarch:
      - amd64
      - arm64
# Arch-dependent images:
dockers:
  - use: buildx
    goarch: amd64
    dockerfile: Dockerfile.goreleaser
    build_flag_templates:
      - "--platform=linux/amd64"
    image_templates:
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:latest-amd64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Version }}-amd64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}.{{ .Minor }}-amd64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}-amd64
  - use: buildx
    goarch: arm64
    dockerfile: Dockerfile.goreleaser
    build_flag_templates:
      - "--platform=linux/arm64"
    image_templates:
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:latest-arm64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Version }}-arm64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}.{{ .Minor }}-arm64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}-arm64
# Multi-arch images:
docker_manifests:
  - name_template: ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:latest
    image_templates:
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:latest-amd64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:latest-arm64
  - name_template: ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Version }}
    image_templates:
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Version }}-amd64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Version }}-arm64
  - name_template: ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}.{{ .Minor }}
    image_templates:
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}.{{ .Minor }}-amd64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}.{{ .Minor }}-arm64
  - name_template: ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}
    image_templates:
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}-amd64
      - ghcr.io/{{- envOrDefault "GITHUB_REPOSITORY" "dns4acme/dsn4acme" | tolower -}}:{{ .Major }}-arm64
signs:
  - cmd: cosign
    args:
      - "sign-blob"
      - "--output-signature=${signature}"
      - "${artifact}"
      - "--yes"
    artifacts: all
docker_signs:
  - artifacts: manifests
    args:
      - "sign"
      - "${artifact}"
      - "--yes"
  - id: sbom-image
    cmd: syft
    args:
      - "scan"
      - "${artifact}"
      - "--enrich"
      - "golang"
      - "--output"
      - "spdx-json=${artifact}.sbom.json"
  - id: attach-attestation
    cmd: cosign
    args:
      - "attach"
      - "attestation"
      - "${artifact}"
      - "--attestation"
      - "${artifact}.sbom.json"
sboms:
  - id: default
    cmd: syft
    args:
      - "scan"
      - "${artifact}"
      - "--enrich"
      - "golang"
      - "--output"
      - "spdx-json=${document}"
